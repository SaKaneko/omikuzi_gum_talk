
# 仕様書

## 概要
- 名前: Omikuzi Gum Talk
- 目的: ランダムにトークテーマ（話題）を提示する軽量なWebアプリケーション。
- 主な実装言語: Python
- 起動方法: `docker-compose` でアプリケーションを起動する。

## 用語
- 話題ファイル: トークテーマを格納したMarkdownファイル。1行目は題名（タイトル）とする。

## ユーザーストーリー
- ユーザーはメイン画面から「おみくじ」「話題一覧」「話題投稿」に遷移できる。
- ユーザーはおみくじを引くと、話題ディレクトリ内のファイルからランダムに1件選ばれ、その内容（Markdown）をおみくじ結果画面で確認できる。
- ユーザーは話題を投稿できる（題名と本文）。投稿はMarkdown形式で保存される。
- ユーザーは話題一覧で題名一覧を確認でき、不要な話題は削除できる。

## 機能要件

### 画面構成（Web UI）
- メイン画面
	- 遷移先: おみくじ画面、話題一覧画面、話題投稿画面。
	- UI: シンプルなナビゲーション。

- おみくじ画面
	- 挙動: おみくじ風アニメーションを再生し、処理完了後にランダム選択された話題の詳細画面（おみくじ結果画面）に遷移。
	- 実装: アニメーションはフロントエンド（CSS/JS）で実現可能。バックエンドへは「ランダム選択」要求のみ送る。

- おみくじ結果画面
	- 表示: 選択された話題ファイルのMarkdownをHTMLに変換して表示。
	- ボタン: 「この話題を削除してメインに戻る」「メインに戻る」
	- 削除時: 確認ダイアログを出し、削除成功時はメイン画面へ戻る。

- 話題投稿画面
	- 入力: 題名（1行）と本文（複数行、Markdown）。
	- 機能: `Preview` ボタンで現在の入力をMarkdownとしてレンダリングして表示（サーバーサイドまたはクライアントサイドでレンダリング可）。
	- 投稿: `投稿` ボタンで話題ディレクトリにファイルを出力する（ファイル名はタイムスタンプ＋安全なスラッグ、UTF-8）。
	- バリデーション: 題名必須、本文必須、ファイル名に不正文字が含まれないこと。

- 話題一覧画面
	- 表示: 話題ディレクトリ内のファイルの先頭行（題名）を一覧表示。本文は表示しない。
	- 操作: 各アイテムに削除ボタンを持つ（削除は確認ダイアログを出す）。

### API エンドポイント（例: Flask ベース）
- `GET /` : メイン画面（HTML）
- `GET /omikuji` : ランダムに話題を選び、選択された話題のIDを返す（JSON）
- `GET /topics` : 話題一覧（題名とIDのリスト）を返す（JSON）
- `GET /topics/<id>` : 指定話題のHTML（Markdown->HTML変換済）を返す
- `POST /topics` : 新規話題作成（フォーム送信またはJSON）。成功時に新規IDを返す
- `POST /topics/preview` : 送信された題名/本文を受け取り、レンダリング結果（HTML）を返す（CSRF不要なAPIとして設計可）
- `DELETE /topics/<id>` : 話題削除（認証が不要なシングルユーザー運用でも削除確認はUI側で行う）

## データ設計（ファイルフォーマット）
- 保存場所: コンテナの永続ボリュームまたはホストマウントされた `topics/` ディレクトリ
- ファイル形式: UTF-8 の Markdown テキスト
- ファイル命名規則: `<timestamp>_<slug>.md` （例: `20260109_121503_how-to-talk.md`）またはUUID。
- ファイル内容の規約: 1行目は題名（タイトル）。2行目以降が本文（Markdown）。

## 国際化（i18n）
- 日本語をキーとし、複数言語対応を `.po` / `.mo` で実現する。
- 実装例: `gettext` / `Flask-Babel` を利用してテンプレートやUI文字列をローカライズ。
- 話題ファイルそのものはユーザーが任意言語で投稿可能。UI 部分のみ翻訳ファイルで対応する。

## オブジェクト指向設計（保守性）
- レイヤー分割: コントローラー（ルーティング） / サービス（ビジネスロジック） / リポジトリ（ファイルI/O） / 変換（Markdown->HTML）
- 主要クラス例:
	- `TopicRepository` : ファイル読み書き、一覧取得、削除、ID解決
	- `OmikujiService` : ランダム選択ロジック
	- `MarkdownRenderer` : マークダウン変換（サニタイズを含む）
	- `I18nManager` : 翻訳ファイルの読み込み

## セキュリティ要件
- Markdown -> HTML 変換後、XSS対策のためサニタイズを行う（例: `bleach` を利用して許可タグのみ許容）。
- ファイル操作時はファイル名を正規化し、パス走査攻撃を防止する。
- CSRF 保護（フォーム投稿がある場合はトークン導入）。
- 入力バリデーション（題名長、本文長の上限）。

## 非機能要件
- 同時アクセス: 小〜中規模を想定（Nginx + Gunicorn のようなWSGI構成でスケール）。
- ロギング: アクセスログ、操作ログ（追加/削除）の記録。
- デプロイ: `docker-compose` で環境変数管理（ローカル開発はボリュームマウントで topics を永続化）。
- 可観測性: 健康チェック用エンドポイント（例: `GET /health`）を用意。

## テスト
- 単体テスト: `TopicRepository` の読み書き、`OmikujiService` のランダム性（分布の検査ではなく動作検証）、`MarkdownRenderer` のレンダリングとサニタイズ。
- 統合テスト: テスト用 `docker-compose` または Flask のテストクライアントを使ってエンドツーエンドを確認。

## 開発・運用手順（例）
- 開発: 
	- コンテナビルド: `docker-compose build`
	- 起動: `docker-compose up`
	- 話題の永続化: `./topics` をホストにマウント
- 本番: 簡易構成なら Gunicorn を用いてコンテナ単体で稼働させ、リバースプロキシに Nginx を配置。

### 例: `docker-compose.yml`（概念）
```
version: '3.8'
services:
	web:
		build: .
		ports:
			- '8000:8000'
		volumes:
			- ./topics:/app/topics
		environment:
			- FLASK_ENV=production
```

## ローカルファイル取り扱いの注意点
- 同時書き込みを避ける: `TopicRepository` はファイル作成時に一時ファイルからの原子的リネームを使う。
- 削除操作はゴミ箱方式（必要に応じて）や単純削除を選べる設計にする。

## 拡張案
- ユーザー認証を追加して個別の投稿や管理を可能にする。
- Web UI のテーマ機能（ダークモード等）。
- 話題にタグ付けやカテゴリ、検索機能を追加する。

## 次の作業候補
- 実装用の最小プロジェクトスキャフォールディング（Flask アプリ、`TopicRepository` の雛形、Dockerfile、docker-compose）を作成。
- 単体テストの雛形を追加。
